<!DOCTYPE html>

<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Build the Metro system of your dreams: create your own metro maps, save them, and share with friends!">

    <meta property="og:title" content="Metro Map Maker">
    <meta property="og:site_name" content="Metro Map Maker">
    <meta property="og:url" content="http://metromapmaker.com">
    <meta property="og:type" content="website">
    <meta property="og:description" content="Build the Metro system of your dreams: create your own metro maps, save them, and share with friends!">
    <meta property="og:image" content="">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="http://metromapmaker.com">
    <meta name="twitter:creator" content="@svthmc">
    <meta name="twitter:title" content="Metro Map Maker">
    <meta name="twitter:description" content="Build the Metro system of your dreams: create your own metro maps, save them, and share with friends!">
    <meta name="twitter:image:src" content="">

    <title>Metro Map Maker</title>

    <link rel="icon" href="favicon.ico">

    <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel='stylesheet' href='css/spectrum.css' />
    <script src="https://use.fontawesome.com/9f1aeb80e7.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-49936574-4', 'auto');
      ga('send', 'pageview');

    </script>

    <style>

    body {
      font-family: 'PT Sans', sans-serif;
    }

    #main-container {
      margin-top: 15px;
      margin-bottom: 15px;
    }

    #controls {
      border: 6px solid #666;
      background-color: #eee;
    }

    #metro-map {
      border: 2px solid black;
    }

    div#toolbox {
      text-align: center;
    }

    #toolbox button {
      display: block;
      margin: 3px;
      width: 100%;
      color: #fff;
    }

    #grid {
      display: flex;
      cursor: crosshair;
      overflow: scroll;
      padding-left: 0;
    }

    .grid-col {
      border: 1px solid;
      border-color: #80CEFF;
      width: 12px;
      height: 12px;
    }

    button {
      /* This makes lighter-colored rail line buttons (and every other button, really) easier to read */
      text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    }

    button.rail-line {
      height: 48px;
      text-align: center;
    }

    #rail-line-bd1038 {
      background-color: #bd1038;
    }

    #rail-line-df8600 {
      background-color: #df8600;
    }

    #rail-line-f0ce15 {
      background-color: #f0ce15;
    }

    #rail-line-00b251 {
      background-color: #00b251;
    }

    #rail-line-0896d7 {
      background-color: #0896d7;
    }

    #rail-line-662c90 {
      background-color: #662c90;
    }

    #rail-line-a2a2a2 {
      background-color: #a2a2a2;
    }

    #rail-line-new {
      background-color: #ff8e88;
    }

    #rail-line-delete {
      background-color: #fc3700;
      height: 48px;
    }

    #create-new-rail-line {
      background-color: #5cb85c;
      border-color: #4cae4c;
    }

    #autosave-indicator {
      margin-top: 10px;
      height: 16px;
    }

    .station {
      outline: 1px solid black;
      border: 3px solid white;
      width: 150%;
      height: 150%;
      position: relative;
      left: -25%;
      top: -25%;
    }

    .transfer-station {
      outline: 3px solid black;
      border: 9px solid white;
      width: 300%;
      height: 300%;
      position: relative;
      left: -100%;
      top: -100%;
    }

    hr {
      border-top: 1px solid #666;
    }

    @media (max-width: 767px) {
      #controls {
        margin-top: 10px;
      }
    }

    </style>


  </head>

<body>

<a name="top"></a>

<div id="main-container" class="container-fluid">

  <div class="visible-xs text-center row">
    <div class="col-lg-10 col-offset-1">
      <h3>Metro Map Maker</h3>
      <h5>Create your own metro maps, save them, and share with friends!</h5>
      <h5>To get started, all the tools you need are below the grid.</h5>
      <h5>(This works best on desktop; some features may not work correctly on your mobile device.)</h5>
    </div>
  </div>

  <div id="grid" class="col-lg-10">
    
  </div>

  <div id="canvas-container" class="col-lg-10 start-hidden">
    <canvas id='metro-map-canvas' width="1600" height="1600" class="img-responsive"></canvas>
  </div>

  <div id="controls" class="col-lg-2 text-center">
    <h3>Metro Map Maker</h3>

    <div id="toolbox">

      <button id="tool-line" class="btn btn-info"><i class="fa fa-subway" aria-hidden="true"></i> Rail Line</button>
      <div id="tool-line-options" class="start-hidden">
        <button id="rail-line-bd1038" class="rail-line">Red Line</button>
        <button id="rail-line-df8600" class="rail-line">Orange Line</button>
        <button id="rail-line-f0ce15" class="rail-line">Yellow Line</button>
        <button id="rail-line-00b251" class="rail-line">Green Line</button>
        <button id="rail-line-0896d7" class="rail-line">Blue Line</button>
        <button id="rail-line-662c90" class="rail-line">Purple Line</button>
        <button id="rail-line-a2a2a2" class="rail-line">Silver Line</button>
        <button id="rail-line-new" class="rail-line">+ Add New Line</button>
        <div id="tool-new-line-options" class="start-hidden">
          <h4 id="tool-new-line-errors" class="bg-danger"></h4>
          <h4>Color of this line</h4>
          <input id="new-rail-line-color" type="color">

          <h4>Name of this line</h4>
          <input id="new-rail-line-name" type="text" placeholder="Blue Line">
          <button id="create-new-rail-line" class="btn btn-success">Create new line</button>
        </div>
        <hr>
        <button id="rail-line-delete">- Delete Unused Lines</button>
      </div>
      
      <button id="tool-station" class="btn btn-info"><i class="fa fa-map-pin" aria-hidden="true"></i> Station</button>
      <div id="tool-station-options" class="start-hidden">
        <h4>Station Name</h4>
        <input id="station-coordinates-x" type="hidden">
        <input id="station-coordinates-y" type="hidden">
        <input id="station-name" type="text" placeholder="Silver Spring">
        <div style="margin: 10px;">
          <input id="station-transfer" type="checkbox"> <label for="station-transfer">Transfer Station</label>
        </div>
        <h4>This station is on these rail lines:</h4>
        <div id="station-on-lines"></div>
        <h4>Add other lines this station serves:</h4>
        <div id="station-other-lines"></div>
      </div>
      <button id="tool-eraser" class="btn btn-info"><i class="fa fa-eraser" aria-hidden="true"></i> Eraser</button>
      <button id="tool-look" class="btn btn-info"><i class="fa fa-eye" aria-hidden="true"></i> Just look</button>
      <button id="tool-grid" class="btn btn-info"><i class="fa fa-table" aria-hidden="true"></i> Hide grid</button>
      <button id="tool-zoom-in" class="btn btn-info"><i class="fa fa-search-plus" aria-hidden="true"></i> Zoom +</button>
      <button id="tool-zoom-out" class="btn btn-info"><i class="fa fa-search-minus" aria-hidden="true"></i> Zoom -</button>
      <button id="tool-move-all" class="btn btn-info"><i class="fa fa-arrows" aria-hidden="true"></i> Move map</button>
      <div id="tool-move-options" class="start-hidden">
        <h5>Be careful! If you move your map out of bounds, you'll lose your work.</h5>
        <button id="tool-move-up" class="btn btn-info"><i class="fa fa-chevron-circle-up" aria-hidden="true"></i> Move everything up</button>
        <button id="tool-move-left" class="btn btn-info"><i class="fa fa-chevron-circle-left" aria-hidden="true"></i> Move everything left</button>
        <button id="tool-move-right" class="btn btn-info"><i class="fa fa-chevron-circle-right" aria-hidden="true"></i> Move everything right</button>
        <button id="tool-move-down" class="btn btn-info"><i class="fa fa-chevron-circle-down" aria-hidden="true"></i> Move everything down</button>
      </div>
      <button id="tool-save-map" class="btn btn-info"><i class="fa fa-share" aria-hidden="true"></i> Save &amp; Share map</button>
      <div id="tool-save-options" class="start-hidden"></div>
      <button id="tool-export-canvas" class="btn btn-info"><i class="fa fa-file-image-o" aria-hidden="true"></i> Download as image</button>
      <div id="export-canvas-help" class="start-hidden">
        <h5>Right click the map and click "Save Image As" to save your finished map.</h5>
        <h5>Or click "Edit map" to continue editing your map.</h5>
      </div>
      <hr>
      <button id="tool-clear-map" class="btn btn-info"><i class="fa fa-trash-o" aria-hidden="true"></i> Clear map</button>
      <hr>
      <div id="autosave-indicator"></div>
      <hr>
      <div id="credits">
        <h5>Created by <a href="https://shannonvturner.com" target="_blank">Shannon Turner</a></h5>
        <h5>Inspired by <a href="https://www.wired.com/2014/01/fantasy-transit-maps/" target="_blank">this</a> and <a href="https://io9.gizmodo.com/5513914/speculative-subway-maps-from-our-underground-future/" target="_blank">this</a></h5>
      </div>

      <hr>

      <div id="remix">
        <h5>Remix these pre-made maps!</h5>
          <p><a href="#">TODO: DC Metro, 2017</a></p>
          <p><a href="#">TODO: DC Metro + Purple Line</a></p>
          <p><a href="#">TODO: SF BART</a></p>
        </ul>
      </div>

    </div> <!-- #toolbox -->

  </div>

  <!-- End editing! Your content goes above -->
</div>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src='js/spectrum.js'></script>

  <script type="text/javascript">

  String.prototype.replaceAll = function(search, replacement) {
      var target = this;
      return target.replace(new RegExp(search, 'g'), replacement);
  };

  function getActiveLine(x, y) {
    // Given an x, y coordinate pair, return the hex code for the line you're on.
    // Use this to retrieve the line for a given point on a map.
    var classes = document.getElementById('coord-x-' + x + '-y-' + y).className.split(/\s+/);
    for (var z=0; z<classes.length; z++) {
      if (classes[z].indexOf('has-line-') >= 0) {
        var activeLine = classes[z].slice(9, 15);
      }
    }
    return activeLine;
  }

  function getStationLines(x, y) {
    // Given an x, y coordinate pair, return the hex codes for the lines this station services.
    var classes = document.getElementById('coord-x-' + x + '-y-' + y).children[0].className.split(/\s+/);  
    var stationLines = [];
    for (var z=0; z<classes.length; z++) {
      if (classes[z].indexOf('has-line-') >= 0) {
        stationLines.push(classes[z].slice(9, 15));
      }
    }
    return stationLines;
  }

  function bindRailLineEvents() {
    $('.rail-line').click(function() {
      if ($(this).attr('id') == 'rail-line-new') {
        // New Rail Line
        $('#tool-new-line-options').show();
      } else {
        // Existing Rail Line
        activeTool = 'line';
        activeToolOption = $(this).css('background-color');
      }
    });  
  }

  function drawGrid() {
    var gridRows = 80, gridCols = 80, grid = "";

    // Generate the grid
    for (var x=0; x<gridRows; x++) {
      grid += '<div class="grid-row">';
      for (var y=0; y<gridCols; y++) {
        grid += '<div id="coord-x-' + x + '-y-' + y + '" class="grid-col"></div>';
      }
      grid += '</div> <!-- div.grid-row -->';
    }

    $('#grid').html(grid);

    // Then bind events to the grid
    $('.grid-col').click(function() {

      $('#station-coordinates-x').val('');
      $('#station-coordinates-y').val('');

      if (activeTool == 'line') {
        $(this).css({
          'background-color': activeToolOption
        });
        $(this).addClass('has-line')
        $(this).addClass('has-line-' + rgb2hex(activeToolOption).slice(1, 7));
      } else if (activeTool == 'eraser') {
        $(this).css({
          'background-color': '#fff'
        });
        $(this).removeClass();
        $(this).addClass('grid-col');
        $(this).html('');
      } else if (activeTool == 'station') {

        $('#station-name').val('');
        $('#station-on-lines').html('');
        var x = $(this).attr('id').slice(8, 10).replace('-', '');
        var y = $(this).attr('id').slice( -2 ).replace('-', '');
        $('#station-coordinates-x').val(x);
        $('#station-coordinates-y').val(y);
        var allLines = $('.rail-line');

        if ($(this).hasClass('has-station')) {
          // Already has a station, so clicking again shouldn't clear the existing station but should allow you to rename it and assign lines
          $('#tool-station-options').show();
          if ($(this).children().attr('id')) {
            // This station already has a name, show it in the textfield
            var stationName = $(this).children().attr('id').replaceAll('_', ' ');
            $('#station-name').val(stationName);

            // Pre-check the box if this is a transfer station
            if ($(this).children().hasClass('transfer-station')) {
              $('#station-transfer').attr('checked', true);
            } else {
              $('#station-transfer').attr('checked', false);
            }

            var stationOnLines = "";
            // var stationLines = getStationLines($("#station-coordinates-x").val(), $("#station-coordinates-y").val());
            var stationLines = getStationLines(x, y);
            for (var z=0; z<stationLines.length; z++) {
              if (stationLines[z]) {
                stationOnLines += "<button style='background-color: #" + stationLines[z] + "' class='station-add-lines' id='add-line-" + stationLines[z] + "'>" + $('#rail-line-' + stationLines[z]).text() + "</button>";  
              }
            }
          } else {
            // This only happens when you create a new station and then click on it again (without having named it first)
            // This fixes the bug where it would erroneously clear the station that it was sitting on and not allow you to add it back
            activeLine = getActiveLine(x, y);
            if (activeLine) {
              $(this).children().addClass('has-line-' + activeLine);
              stationOnLines = "<button style='background-color: #" + activeLine + "' class='station-add-lines' id='add-line-" + activeLine + "'>" + $('#rail-line-' + activeLine).text() + "</button>";
              stationLines = activeLine;
            }
          }
        } else {
          // Create a new station
          $(this).addClass('has-station');
          $(this).html('<div class="station"></div>');
          $('#tool-station-options').show();

          // Pre-populate the station with the line it sits on
          // activeLine = getActiveLine($("#station-coordinates-x").val(), $("#station-coordinates-y").val());
          activeLine = getActiveLine(x, y);
          if (activeLine) {
            // If the station is added to a space with no rail line, don't add any active lines
            $(this).children().addClass('has-line-' + activeLine);
            stationOnLines = "<button style='background-color: #" + activeLine + "' class='station-add-lines' id='add-line-" + activeLine + "'>" + $('#rail-line-' + activeLine).text() + "</button>";
            stationLines = activeLine;
          }
        }

        // Make the station options button collapsible
        if ($('#tool-station-options').is(':visible')) {
          $('#tool-station').html('<i class="fa fa-map-pin" aria-hidden="true"></i> Hide Station Options');
        }

        // Add lines to the "Other lines this station serves" option
        if (stationOnLines) {
          $('#station-on-lines').html(stationOnLines);

          var linesToAdd = "";
          
          for (var z=0; z<allLines.length; z++) {
            if ((stationLines == allLines[z].id.slice(10, 16) || stationLines.indexOf(allLines[z].id.slice(10,16)) >= 0) || allLines[z].id.slice(10,16) == 'new') {
              // Looping through all of the lines, if this line is already in the station's lines, don't add it
              // Don't add the "Add new line" button either
            } else {
              linesToAdd += '<button style="background-color: #' + allLines[z].id.slice(10, 16) + '" class="station-add-lines" id="add-line-' + allLines[z].id.slice(10, 16) + '">' + $('#' + allLines[z].id).text() + '</button>';
            }
          } // for allLines
          if (linesToAdd) {
            $('#station-other-lines').html(linesToAdd);
            // Bind the event to the .station-add-lines buttons here since they are newly created.
            $('.station-add-lines').click(function() {
              if ($(this).parent().attr('id') == 'station-other-lines') {
                $('#station-on-lines').append($(this));
                $('#coord-x-' + x + '-y-' + y).children().addClass('has-line-' + $(this).attr('id').slice(9, 15));

              } else {
                // Remove it
                $('#station-other-lines').append($(this));
                $('#coord-x-' + x + '-y-' + y).children().removeClass('has-line-' + $(this).attr('id').slice(9, 15));
              }
              
            });
          } // if linesToAdd
        } // if stationOnLines
      } // if activeTool == station
    });

    $('.grid-col').mouseover(function() {
      if (mouseIsDown) {
        $(this).click();
        saveMapAsObject();
      }
    });

  }

  function rgb2hex(rgb) {
      if (/^#[0-9A-F]{6}$/i.test(rgb)) return rgb;

      rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
      function hex(x) {
          return ("0" + parseInt(x).toString(16)).slice(-2);
      }
      return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
  }

  function autoSave() {
    // TODO
  }

  function getURLParameter(name) {
      return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
  }

  function autoLoad() {
    var savedMapHash = getURLParameter('map');
    if (savedMapHash) {
      $.get('http://metromapmaker.com/save/' + savedMapHash).done(function (savedMapData) {
        savedMapData = savedMapData.replaceAll('u&#39;', '"').replaceAll('&#39;', '"');
        loadMapFromObject(JSON.parse(savedMapData));
      });
    } else if (window.localStorage.getItem('metroMap')) {
      // Load from local storage
      loadMapFromObject(JSON.parse(window.localStorage.getItem('metroMap'))); 
    }
  }

  function loadMapFromObject(metroMapObject) {

    // loadMapFromObject(metroMap)

    for (var x in metroMapObject) {
      if (metroMapObject.hasOwnProperty(x)) {
        for (var y in metroMapObject[x]) {
          if (metroMapObject[x].hasOwnProperty(y)) {
            $('#coord-x-' + x + '-y-' + y).addClass('has-line');
            $('#coord-x-' + x + '-y-' + y).addClass('has-line-' + metroMapObject[x][y]['line']);
            $('#coord-x-' + x + '-y-' + y).css({
                'background-color': '#' + metroMapObject[x][y]['line']
            });
            if (metroMapObject[x][y]["station"]) {
              $('#coord-x-' + x + '-y-' + y).addClass('has-station');
              $('#coord-x-' + x + '-y-' + y).html('<div id="' + metroMapObject[x][y]["station"]["name"] +'" class="station"></div>');
              if (metroMapObject[x][y]["station"]["transfer"] == 1) {
                $('#' + metroMapObject[x][y]["station"]["name"]).addClass('transfer-station');
              }
              if (metroMapObject[x][y]["station"]["lines"] && metroMapObject[x][y]['station']['name']) {
                for (var z=0; z<metroMapObject[x][y]["station"]["lines"].length; z++) {
                  $('#' + metroMapObject[x][y]["station"]["name"]).addClass('has-line-' + metroMapObject[x][y]["station"]["lines"][z]);
                  // Rail line buttons should use their color for the buttons, too.
                  $('<style>').prop('type', 'text/css')
                  .html('#rail-line-' + metroMapObject[x][y]["station"]["lines"][z] + ', .has-line-' + metroMapObject[x][y]["station"]["lines"][z] + '{ background-color: #' + metroMapObject[x][y]["station"]["lines"][z] + '; }').appendTo('head');
                }  
              }
            } // if station
          } // if y
        } // for y in x
      } // if x
    } // for x in map

    var originalLines = ['bd1038', 'df8600', 'f0ce15', '00b251', '0896d7', '662c90', 'a2a2a2'];

    for (var line in metroMapObject['global']['lines']) {
      if (metroMapObject['global']['lines'].hasOwnProperty(line)) {
        if (originalLines.indexOf(line) >= 0) {
          // Don't add lines that already appear pre-populated in the menu or they will show up duplicated on every refresh
        } else {
          $('#rail-line-new').before('<button id="rail-line-' + line + '" class="rail-line btn-info" style="background-color: #' + line + ';">' + metroMapObject['global']['lines'][line]['displayName'] + '</button>')  
        }
      }
    }
  } // function loadMapFromObject

  function saveMapAsObject() {
    console.log('Saving');
    var gridRows = 80, gridCols = 80;

    metroMap = new Object;

    for (var x=0; x<gridRows; x++) {
      for (var y=0; y<gridCols; y++) {
        var classes = document.getElementById('coord-x-' + x + '-y-' + y).className.split(/\s+/);
        // Example: ["grid-col", "has-line", "has-line-f0ce15", "has-station"]
        if (classes.indexOf('has-line') >= 0) {
          if (metroMap[x] === undefined) {
            metroMap[x] = new Object;
          }
          if (metroMap[x][y] === undefined) {
            metroMap[x][y] = new Object;
          }

          activeLine = getActiveLine(x, y);
          metroMap[x][y]['line'] = activeLine;

          // Stations must exist on a line in order to be valid.
          if (classes.indexOf('has-station') >= 0) {
            var stationLines = getStationLines(x, y);
            var activeStation = document.getElementById('coord-x-' + x + '-y-' + y).children[0].id;
            if (activeStation) {
              // Stations must have a name in order to be valid.
                metroMap[x][y]['station'] = {
                'name': activeStation,
                'lines': stationLines
              }
              if ($('#' + activeStation).hasClass('transfer-station')) {
                metroMap[x][y]['station']['transfer'] = 1;
              } // if transfer station
            } // if station name
          } // if has-station
        } // if has-line
      } // for y
    } // for x

    // Save the names of the rail lines
    metroMap['global'] = new Object;
    metroMap['global']['lines'] = new Object;
    $('.rail-line').each(function() {
      if ($(this).attr('id') != 'rail-line-new') {
        // rail-line-
        metroMap['global']['lines'][$(this).attr('id').slice(10, 16)] = {
          'displayName': $(this).text()
        }
      }
    });

    window.localStorage.setItem('metroMap', JSON.stringify(metroMap));

    $('#autosave-indicator').html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i> Saving ...')
    setTimeout(function() {
      $('#autosave-indicator').html('');
    }, 1500)

    return JSON.stringify(metroMap);
  } // function saveMapAsObject()

  $(document).ready(function() {

    // Bind to the mousedown and mouseup events so we can implement dragging easily
    mouseIsDown = false;
    $(document).mousedown(function() {
        mouseIsDown = true;
    }).mouseup(function() {
        mouseIsDown = false;
    });

    drawGrid();
    autoLoad();
    bindRailLineEvents();
    
    $('.start-hidden').each(function() {
      $(this).hide();
    })

    activeTool = 'look';

    $('#toolbox button').click(function() {
      $('#toolbox button').removeClass('btn-primary').addClass('btn-info');
      $(this).removeClass('btn-info');
      $(this).addClass('btn-primary')
    })

    // Toolbox
    $('#tool-line').click(function() {
      // Expand Rail line options
      if ($('#tool-line-options').is(':visible')) {
        $('#tool-line-options').hide();
        $('#tool-new-line-options').hide();
        $('#tool-line').html('<i class="fa fa-subway" aria-hidden="true"></i> Rail Line');
      } else {
        $('#tool-line-options').show();
        $('#tool-line').html('<i class="fa fa-subway" aria-hidden="true"></i> Hide Rail Line options');
      }
    });
    $('#rail-line-delete').click(function() {
      // Only delete lines that aren't in use
      var allLines = $('.rail-line');
      var linesToDelete = [];
      for (var a=0; a<allLines.length; a++) {
        if ($('.rail-line')[a].id != 'rail-line-new') {
          // Is this line in use at all?
          if ($('.has-line-' + $('.rail-line')[a].id.slice(10, 16)).length == 0) {
            linesToDelete.push($('#' + $('.rail-line')[a].id));
          }
        }
      }
      if (linesToDelete.length > 0) {
        for (var d=0; d<linesToDelete.length; d++) {
          linesToDelete[d].remove();
        }
      }
    });
    $('#tool-station').click(function() {
      activeTool = 'station';
      if ($('#tool-station-options').is(':visible')) {
        $('#tool-station-options').hide();
        $('#tool-station').html('<i class="fa fa-map-pin" aria-hidden="true"></i> Station');
      }
    });
    $('#tool-eraser').click(function() {
      activeTool = 'eraser';
    })
    $('#tool-look').click(function() {
      activeTool = 'look';
    });
    $('#tool-grid').click(function() {
      if ($('.grid-col').css('border-color') == 'rgb(128, 206, 255)' || $('.grid-col').css('border-top-color') == 'rgb(128, 206, 255)') {
        $('.grid-col').css('border-color', '#fff');
        $('#tool-grid').html('<i class="fa fa-table" aria-hidden="true"></i> Show grid');
      } else {
        $('.grid-col').css('border-color', '#80CEFF');
        $('#tool-grid').html('<i class="fa fa-table" aria-hidden="true"></i> Hide grid');
      }
    });
    $('#tool-zoom-in').click(function() {
      var gridSize = $('.grid-col').width();
      if (gridSize < 50) {
        $('.grid-col').width(gridSize + 2);
        $('.grid-col').height(gridSize + 2);
      }
    });
    $('#tool-zoom-out').click(function() {
      var gridSize = $('.grid-col').width();
      if (gridSize > 8) {
        $('.grid-col').width(gridSize - 2);
        $('.grid-col').height(gridSize - 2); 
      }
    });
    $('#tool-move-all').click(function() {
      if ($('#tool-move-options').is(':visible')) {
        $('#tool-move-options').hide();
        $('#tool-move-all').html('<i class="fa fa-arrows" aria-hidden="true"></i> Move map')
      } else {
        $('#tool-move-options').show();
        $('#tool-move-all').html('<i class="fa fa-arrows" aria-hidden="true"></i> Hide Move options')
      }
    });
    $('#tool-move-up').click(function() {
      var gridRows = 80, gridCols = 80;
      for (var y=0; y<gridCols; y++) {
        for (var x=0; x<gridRows; x++) {

          // Remove all classes from current grid item (except .grid-col)
          var classes = document.getElementById('coord-x-' + x + '-y-' + y).className.split(/\s+/);
          for (var c=0; c<classes.length; c++) {
            if (classes[c] != 'grid-col') {
              // Don't remove .grid-col or you'll have to re-bind all of the .grid-col events
              $('#coord-x-' + x + '-y-' + y).removeClass(classes[c]);
            }
          }

          if (y == 79) {
            // Clear the last row
            $('#coord-x-' + x + '-y-' + y).html('');
            $('#coord-x-' + x + '-y-' + y).removeAttr('style');
          } else {
            // Get all classes from the next grid item
            var classes = document.getElementById('coord-x-' + x + '-y-' + parseInt(y + 1)).className.split(/\s+/);

            // Move all classes from the next grid item to the current
            for (var c=0; c<classes.length; c++) {
              // Move all classes
              if (classes[c] != 'grid-col') {
                $('#coord-x-' + x + '-y-' + y).addClass(classes[c]);
              }
              // Move all styling
              $('#coord-x-' + x + '-y-' + y).removeAttr('style');
              $('#coord-x-' + x + '-y-' + y).attr('style', $('#coord-x-' + x + '-y-' + parseInt(y + 1)).attr('style'));
            }

            // Move any children too, overwriting any existing contents
            $('#coord-x-' + x + '-y-' + y).html($('#coord-x-' + x + '-y-' + parseInt(y + 1)).html());
          }
        } // for x
      } // for y
    });
    $('#tool-move-down').click(function() {
      var gridRows = 80, gridCols = 80;
      for (var y=gridCols - 1; y>=0; y--) {
        for (var x=0; x<gridRows; x++) {

          // Remove all classes from current grid item (except .grid-col)
          var classes = document.getElementById('coord-x-' + x + '-y-' + y).className.split(/\s+/);
          for (var c=0; c<classes.length; c++) {
            if (classes[c] != 'grid-col') {
              // Don't remove .grid-col or you'll have to re-bind all of the .grid-col events
              $('#coord-x-' + x + '-y-' + y).removeClass(classes[c]);
            }
          }

          if (y == 0) {
            // Clear the last row
            $('#coord-x-' + x + '-y-' + y).html('');
            $('#coord-x-' + x + '-y-' + y).removeAttr('style');
          } else {
            // Get all classes from the next grid item
            var classes = document.getElementById('coord-x-' + x + '-y-' + parseInt(y - 1)).className.split(/\s+/);

            // Move all classes from the next grid item to the current
            for (var c=0; c<classes.length; c++) {
              // Move all classes
              if (classes[c] != 'grid-col') {
                $('#coord-x-' + x + '-y-' + y).addClass(classes[c]);
              }
              // Move all styling
              $('#coord-x-' + x + '-y-' + y).removeAttr('style');
              $('#coord-x-' + x + '-y-' + y).attr('style', $('#coord-x-' + x + '-y-' + parseInt(y - 1)).attr('style'));
            }

            // Move any children too, overwriting any existing contents
            $('#coord-x-' + x + '-y-' + y).html($('#coord-x-' + x + '-y-' + parseInt(y - 1)).html());
          }
        } // for x
      } // for y
    });
    $('#tool-move-left').click(function() {
      var gridRows = 80, gridCols = 80;
      for (var x=0; x<gridRows; x++) {
        for (var y=0; y<gridCols; y++) {

          // Remove all classes from current grid item (except .grid-col)
          var classes = document.getElementById('coord-x-' + x + '-y-' + y).className.split(/\s+/);
          for (var c=0; c<classes.length; c++) {
            if (classes[c] != 'grid-col') {
              // Don't remove .grid-col or you'll have to re-bind all of the .grid-col events
              $('#coord-x-' + x + '-y-' + y).removeClass(classes[c]);
            }
          }

          if (x == 79) {
            // Clear the last column
            $('#coord-x-' + x + '-y-' + y).html('');
            $('#coord-x-' + x + '-y-' + y).removeAttr('style');
          } else {
            // Get all classes from the next grid item
            var classes = document.getElementById('coord-x-' + parseInt(x + 1) + '-y-' + y).className.split(/\s+/);

            // Move all classes from the next grid item to the current
            for (var c=0; c<classes.length; c++) {
              // Move all classes
              if (classes[c] != 'grid-col') {
                $('#coord-x-' + x + '-y-' + y).addClass(classes[c]);
              }
              // Move all styling
              $('#coord-x-' + x + '-y-' + y).removeAttr('style');
              $('#coord-x-' + x + '-y-' + y).attr('style', $('#coord-x-' + parseInt(x + 1) + '-y-' + y).attr('style'));
            }

            // Move any children too, overwriting any existing contents
            $('#coord-x-' + x + '-y-' + y).html($('#coord-x-' + parseInt(x + 1) + '-y-' + y).html());
          }
        } // for y
      } // for x
    });
    $('#tool-move-right').click(function() {
      var gridRows = 80, gridCols = 80;
      for (var x=gridRows - 1; x>=0; x--) {
        for (var y=0; y<gridCols; y++) {

          // Remove all classes from current grid item (except .grid-col)
          var classes = document.getElementById('coord-x-' + x + '-y-' + y).className.split(/\s+/);
          for (var c=0; c<classes.length; c++) {
            if (classes[c] != 'grid-col') {
              // Don't remove .grid-col or you'll have to re-bind all of the .grid-col events
              $('#coord-x-' + x + '-y-' + y).removeClass(classes[c]);
            }
          }

          if (x == 0) {
            // Clear the last column
            $('#coord-x-' + x + '-y-' + y).html('');
            $('#coord-x-' + x + '-y-' + y).removeAttr('style');
          } else {
            // Get all classes from the next grid item
            var classes = document.getElementById('coord-x-' + parseInt(x - 1) + '-y-' + y).className.split(/\s+/);

            // Move all classes from the next grid item to the current
            for (var c=0; c<classes.length; c++) {
              // Move all classes
              if (classes[c] != 'grid-col') {
                $('#coord-x-' + x + '-y-' + y).addClass(classes[c]);
              }
              // Move all styling
              $('#coord-x-' + x + '-y-' + y).removeAttr('style');
              $('#coord-x-' + x + '-y-' + y).attr('style', $('#coord-x-' + parseInt(x - 1) + '-y-' + y).attr('style'));
            }

            // Move any children too, overwriting any existing contents
            $('#coord-x-' + x + '-y-' + y).html($('#coord-x-' + parseInt(x - 1) + '-y-' + y).html());
          }
        } // for y
      } // for x
    });
    $('#tool-save-map').click(function() {
      activeTool = 'look';
      var savedMap = saveMapAsObject();
      var saveMapURL = 'http://metromapmaker.com/save/';
      $.post( saveMapURL, {
        'metroMap': savedMap
      }).done(function(data) {
        if (data.slice(0,7) == '[ERROR]') {
          // TODO: some error handling
        } else {
          $('#tool-save-options').html('<h5 style="overflow-x: hidden;">Map Saved! You can share your map with a friend by using this link: <a href="http://metromapmaker.com/?map=' + data + ' " target="_blank">http://metromapmaker.com/?map=' + data + '</a></h5> <h5>You can then share this URL with a friend - and they can remix your map without you losing your original! If you make changes to this map, click Save and Share again to get a new URL.</h5>');
          $('#tool-save-options').show();
        }
      });
    });
    $('#tool-export-canvas').click(function() {
      activeTool = 'look';

      if ($('#grid').is(':visible')) {
        $('#grid').hide();
        $('#canvas-container').show();
        $('#export-canvas-help').show();
        $('#tool-export-canvas').html('<i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit map');
      } else {
        $('#grid').show();
        $('#canvas-container').hide();
        $('#export-canvas-help').hide();
        $('#tool-export-canvas').html('<i class="fa fa-file-image-o" aria-hidden="true"></i> Download as image');
      }
      
      var canvas = document.getElementById('metro-map-canvas');
      var ctx = canvas.getContext('2d');
      var gridRows = 80, gridCols = 80;
      // How much larger is the canvas than the grid has in squares?
      // If the grid has 80x80 squares and the canvas is 1600x1600,
      //    then the gridPixelMultiplier is 20 (1600 / 80)
      var gridPixelMultiplier = canvas.width / gridCols; // 20

      // Clear the old canvas if it was drawn
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Make the background white instead of transparent
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      for (var x=0; x<gridRows; x++){
        for (var y=0; y<gridCols; y++) {

          if ($('#coord-x-' + x + '-y-' + y).hasClass('has-line')) {
            // Get color of the line
            ctx.fillStyle = '#' + getActiveLine(x, y);
            // ctx.moveTo(x * gridPixelMultiplier, y * gridPixelMultiplier); // I'm not sure this does anything

            // arc(x, y, radius, startAngle, endAngle, anticlockwise)
            // Draw an arc centered at x, y position with radius r
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * .9, 0, Math.PI * 2, true); // Rail-line circle
            ctx.closePath();
            ctx.fill();
          } // if .has-line
        } // for y
      } // for x

      // Draw the stations last (and separately), or they will be painted over by the lines themselves.
      ctx.font = '20px sans-serif';

      for (var x=0; x<gridRows; x++){
        for (var y=0; y<gridCols; y++) {
          if ($('#coord-x-' + x + '-y-' + y).hasClass('has-station') && $('#coord-x-' + x + '-y-' + y).children().hasClass('transfer-station')) {
            // Outer circle
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * 1.2, 0, Math.PI * 2, true); 
            ctx.closePath();
            ctx.fill();

            // Inner circle
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * .9, 0, Math.PI * 2, true); 
            ctx.closePath();
            ctx.fill();

            // Outer circle
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * .6, 0, Math.PI * 2, true); 
            ctx.closePath();
            ctx.fill();

            // Inner circle
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * .3, 0, Math.PI * 2, true); 
            ctx.closePath();
            ctx.fill();


            var activeStation = document.getElementById('coord-x-' + x + '-y-' + y).children[0].id;
            ctx.fillStyle = '#000000';
            ctx.fillText(activeStation, (x * gridPixelMultiplier) + (gridPixelMultiplier * 1.5), (y * gridPixelMultiplier) + gridPixelMultiplier / 4);
          } else if ($('#coord-x-' + x + '-y-' + y).hasClass('has-station')) {
            // Outer circle
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * .6, 0, Math.PI * 2, true); 
            ctx.closePath();
            ctx.fill();

            // Inner circle
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(x * gridPixelMultiplier, y * gridPixelMultiplier, gridPixelMultiplier * .3, 0, Math.PI * 2, true); 
            ctx.closePath();
            ctx.fill();

            var activeStation = document.getElementById('coord-x-' + x + '-y-' + y).children[0].id;
            ctx.fillStyle = '#000000';
            ctx.fillText(activeStation, (x * gridPixelMultiplier) + gridPixelMultiplier, (y * gridPixelMultiplier) + gridPixelMultiplier / 4);
          } // if .has-station

        } // for y
      } // for x
    }); // #tool-export-canvas.click()
    $('#tool-clear-map').click(function() {
      drawGrid();
      window.localStorage.removeItem('metroMap');
    });

    $('#create-new-rail-line').click(function() {

      $('#new-rail-line-name').val($('#new-rail-line-name').val().replaceAll('<', '').replaceAll('>', '').replaceAll('"', '').replaceAll('&', '&amp;').replaceAll('/', '&#x2f;').replaceAll("'", '&#27;'));

      var allColors = [], allNames = [];
      $('.rail-line').each(function() {
        allColors.push($(this).attr('id').slice(10, 16));
        allNames.push($(this).text());
      });

      if (allColors.indexOf($('#new-rail-line-color').val().slice(1, 7)) >= 0) {
        // This color already exists!
        $('#tool-new-line-errors').text('This color already exists! Please choose a new color.');
      } else if (allNames.indexOf($('#new-rail-line-name').val()) >= 0) {
        // This rail name already exists!
        $('#tool-new-line-errors').text('This rail line name already exists! Please choose a new name.');
      } else if ($('#new-rail-line-name').val().length == 0) {
        $('#tool-new-line-errors').text('This rail line name cannot be blank. Please enter a name.');
      } else {
        $('#tool-new-line-errors').text('');
        $('#rail-line-new').before('<button id="rail-line-' + $('#new-rail-line-color').val().slice(1, 7) + '" class="rail-line btn-info" style="background-color: ' + $('#new-rail-line-color').val() + ';">' + $('#new-rail-line-name').val() + '</button>');
        saveMapAsObject();
      }

      // Re-bind events to .rail-line -- otherwise, newly created lines won't have events
      bindRailLineEvents();

    })

    $('#station-name').change(function() {
      // Get the coordinates where this station was placed
      // Use this to pre-populate which line this station services
      $(this).val($(this).val().replaceAll('"', '').replaceAll("'", '').replaceAll('<', '').replaceAll('>', '').replaceAll('&', '').replaceAll('/', ''))
      var x = $('#station-coordinates-x').val();
      var y = $('#station-coordinates-y').val();
      if (x >= 0 && y >= 0 ) {
        $('#coord-x-' + x + '-y-' + y + ' .station').attr('id', $('#station-name').val().replaceAll(' ', '_'));  
      }

      saveMapAsObject();
    });

    $('#station-transfer').click(function() {
      // Get the coordinates where this station was placed
      // Use this to pre-populate which line this station services

      var x = $('#station-coordinates-x').val();
      var y = $('#station-coordinates-y').val();
      if (x >= 0 && y >= 0 ) {
        if ($(this).is(':checked')) {
           $('#coord-x-' + x + '-y-' + y + ' .station').addClass('transfer-station');
        } else {
           $('#coord-x-' + x + '-y-' + y + ' .station').removeClass('transfer-station');
        }
      }
    });

  });

  

  </script>

  </body>
</html>